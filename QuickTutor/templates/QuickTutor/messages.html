{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'QuickTutor/css/messages.css' %}">

<!-- Main container -->
<div class="main__container">

    <!-- Mask -->
    <div class="chat__mask">

        <!-- Conversation container -->
        <div class="chat__container">

            <!-- Conversation view -->
            <section class="conversation__view">

                <!-- Header -->
                <header class="conversation__view__header">
                    <button class="list__view__link" title="Go to chat list">
                        <svg viewBox="79.229 169.229 453.543 453.543">
                            <path
                                d="M79.229,562.299c0-25.048,20.306-45.354,45.354-45.354c25.048,0,45.354,20.307,45.354,45.354
                                c0,25.049-20.306,45.354-45.354,45.354C99.534,607.653,79.229,587.348,79.229,562.299z M124.583,275.055
                                c25.048,0,45.354-20.306,45.354-45.354c0-25.048-20.306-45.354-45.354-45.354c-25.049,0-45.354,20.306-45.354,45.354
                                C79.229,254.75,99.534,275.055,124.583,275.055z M124.583,441.354c25.048,0,45.354-20.306,45.354-45.354
                                c0-25.048-20.306-45.354-45.354-45.354c-25.049,0-45.354,20.306-45.354,45.354C79.229,421.049,99.534,441.354,124.583,441.354z				 M275.764,259.937h226.771c16.699,0,30.236-13.537,30.236-30.236c0-16.699-13.537-30.236-30.236-30.236H275.764
                                c-16.699,0-30.236,13.538-30.236,30.236C245.528,246.4,259.065,259.937,275.764,259.937z M275.764,426.236h226.771
                                c16.699,0,30.236-13.537,30.236-30.236c0-16.699-13.537-30.236-30.236-30.236H275.764c-16.699,0-30.236,13.538-30.236,30.236	C245.528,412.699,259.065,426.236,275.764,426.236z M275.764,592.535h226.771c16.699,0,30.236-13.537,30.236-30.236
                                s-13.537-30.235-30.236-30.235H275.764c-16.699,0-30.236,13.536-30.236,30.235S259.065,592.535,275.764,592.535z" />
                        </svg>
                    </button>
                    <button class="conversation__new__message" title="New message">
                        <svg viewBox="267.703 307.625 16 18.386">
                            <g>
                                <path
                                    d="M278.954,322.634c0.444,1.011-0.015,2.191-1.026,2.633c-1.011,0.444-2.19-0.015-2.633-1.026
                                c-0.119-0.271-0.167-0.553-0.164-0.83l3.324-1.457C278.661,322.136,278.834,322.365,278.954,322.634z" />
                                <path
                                    d="M268.688,317.353c-0.938-2.361-0.46-4.61,0.941-6.082c-0.058-0.089-0.115-0.171-0.159-0.273c-0.444-1.01,0.015-2.187,1.026-2.63c1.011-0.443,2.189,0.018,2.633,1.027c0.042,0.096,0.065,0.195,0.09,0.293
                                c2.101-0.042,4.175,1.236,5.258,3.412c0,0,1.605,3.686,3.368,3.979c0.054,0.003,1,0.027,1.288,0.715c0.271,0.652-0.287,1.525-1.262,1.945l-10.548,4.546c-0.973,0.419-2.047,0.25-2.278-0.417c-0.227-0.657,0.272-1.269,0.319-1.323C270.36,321.016,268.688,317.353,268.688,317.353z" />
                            </g>
                        </svg>
                    </button>
                    <section class="conversation__user__info">
                        <span class="conversation__user__status"></span>
                        <span class="conversation__user__name">{{ commName }}</span>
                    </section>
                    <div class="conversation__view__actions">
                        <button class="conversation__actions__videocall" title="Start videocall">
                            <svg viewBox="0 0 24 22">
                                <path
                                    d="M16,16c0,1.1-0.9,2-2,2H2c-1.1,0-2-0.9-2-2V8c0-1.1,0.9-2,2-2h12c1.1,0,2,0.9,2,2V16z M24,6l-6,4.2v3.6l6,4.2V6z" />
                            </svg>
                        </button>
                        <button class="conversation__actions__close" title="Close conversation">
                            <svg viewBox="0 0 22 22">
                                <path
                                    d="M23,20.2L14.8,12L23,3.8L20.2,1L12,9.2L3.8,1L1,3.8L9.2,12L1,20.2L3.8,23l8.2-8.2l8.2,8.2L23,20.2z" />
                            </svg>
                        </button>
                    </div>
                </header>

                <!-- Conversation -->
                <section class="conversation__view__body">

                </section>
                <footer class="conversation__view__write">
                    <input id="chat__input" type="text" value="" name="writeMessage" placeholder="Enter message here"
                        class="chat__conversation__input">
                    <button class="chat__conversation__send" title="Send message">
                        <svg viewBox="-2 0 24 24">
                            <path d="M5,3l3.1-3L20,12L8.1,24L5,21l9-9L5,3z" />
                        </svg>
                    </button>
                </footer>
            </section>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {

        // Minimize of the chat window.
        $('.conversation__user__info, .list__view__header').on('click', function () {
            $('.chat__mask').toggleClass('chat__mask--minimize');
        });

        function sendMessage() {
            // Get text message from input.
            var newMessage = $('#chat__input').val();
            // If input is empty and tries to send message, prevent sending.
            if (newMessage == '') {
                return false;
            } else {
                

                // append to database
                $.ajax({
                    url: "/store_message/" + newMessage + "/{{sender}}{{personalmsgID}}/{{receiver}}{{oppmsgID}}/", 
                    success: function () {console.log('nice');},
                    complete: function () {}
                });

                // Clear input.
                $('#chat__input').val('');
            }
        }

        $('.chat__conversation__send').on('click', function () {
            sendMessage();
        });

        $('#chat__input').keypress(function (e) {
            if (e.which == 13) {
                sendMessage();
            }
        });

        // Show new message notification after x seconds.
        function newMessage() {
            $('.conversation__new__message').addClass('chat__notification--active');
            $('#chatID-2 .item__user').addClass('chat__item--new');
        }
        setTimeout(newMessage, 4000);

        // Click to go to the conversation.
        $('#chatID-1').on('click', function () {
            $('.chat__container').removeClass('chat__list--active');
        });

        // Remove notification classes.
        $('#chatID-2').on('click', function () {
            $('#chatID-2').addClass('close__chat');
        });

        // Click to close chat conversation from the list.
        $('.item__close').on('click', function () {
            $(this).parent().addClass('close__chat');
        });

        // Click to close chat window altogether.
        $('.conversation__actions__close').on('click', function () {
            $('.chat__mask').toggleClass('chat__mask--minimize');
        });

        getMessages();

    });

    let msgsShown = 0;

    function getMessages() {
        $.ajax({
            url: "/get_message/{{sender}}{{personalmsgID}}/{{receiver}}{{oppmsgID}}/", 
            success: function(data) {
                for(let idx=msgsShown; idx < data.length; idx++){
                    if(data[idx].mine == 1) {
                        $('<article class="conversation__view__bubbles"><p class="chat__right__bubble">' + data[idx].content + '</p></article>').appendTo('.conversation__view__body');
                    } else {
                        $('<article class="conversation__view__bubbles"><p class="chat__left__bubble">' + data[idx].content + '</p></article>').appendTo('.conversation__view__body');
                    }
                    msgsShown++;
                }
                
                setTimeout(getMessages, 250); 
            },
            complete: function() {
            },
            error: function() {
                setTimeout(getMessages, 250); 
            }
        });
                
    }

</script>